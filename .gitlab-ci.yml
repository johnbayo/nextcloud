image: docker:latest

services:
  - docker:dind

stages:
  - build_image

before_script:
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  - export REG_PREFIX="${CI_REGISTRY}/${CI_PROJECT_PATH}"

build_image_nextcloud-dev:
  variables:
    SERVICE_NAME: "nextcloud"
  stage: build_image
  script:
     - export SERVICE_NAME="$SERVICE_NAME"
     - export IMAGE_NAME="${REG_PREFIX}:${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHA:0:8}"
     - echo "${IMAGE_NAME}"
     - docker build --pull -t "${IMAGE_NAME}" -f "docker/${SERVICE_NAME}/Dockerfile" "docker/${SERVICE_NAME}"
     - docker push "${IMAGE_NAME}"
  only:
    refs:
      - dev
    changes:
      - docker/**